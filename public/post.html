<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <nav>
        <ul>
            <li><a href="/index.html">Explore</a></li>
            <li><a href="/post.html">Post</a></li>
        </ul>
    </nav>
    <div class="container">
        <article id="video-article" hidden>
            <video id="player" width="100%" autoplay></video>
            <div class="button-container">
                <button onclick="takePhoto()">Take</button>
            </div>
        </article>
        <article id="canvas-article" hidden>
            <canvas id="taken-photo"></canvas>
            <div class="button-container">
                <button onclick="uploadPhoto('canvas')">Post</button>
                <button onclick="showOnly('video-article')">Discard</button>
            </div>
        </article>
        <article id="upload-article" hidden>
            <input type="file" id="file" name="filephoto" accept="image/png" size="">
            <div class="button-container">
                <button onclick="uploadPhoto('file')">Upload</button>
            </div>
        </article>
    </div>

    <script>
        if('mediaDevices' in navigator) {
            navigator.mediaDevices.getUserMedia({video: true, audio: false})
                .then(function(stream) {
                    let player = document.getElementById('player');
                    player.srcObject = stream;
                    showOnly('video-article');
                })
                .catch(function(err) {
                    console.log(err);
                    showOnly('upload-article');
                });
        } else {
            showOnly('upload-article');
        }

        function showOnly(id){
            let articles = document.getElementsByTagName('article');
            for(let article of articles){
                article.setAttribute("hidden", "true");
            }
            document.getElementById(id).removeAttribute("hidden");
        }

        function takePhoto(){
            let player = document.getElementById('player');
            let canvas = document.getElementById('taken-photo');
            let width = player.videoWidth;
            let height = player.videoHeight;
            canvas.width = width;
            canvas.height = height;
            canvas.getContext('2d')
                .drawImage(player, 0, 0, width, height);
            showOnly('canvas-article');
        }

        async function uploadPhoto(type){
            let blob;
            if(type === 'canvas'){
                let canvas = document.getElementById('taken-photo');
                let arr = canvas.toDataURL('image/png').split(',');
                let mime = arr[0].match(/:(.*?);/)[1];
                let bstring = atob(arr[1]);
                let u8arr = new Uint8Array(bstring.length);
                for(let i=0;i<bstring.length;i++){
                    u8arr[i] = bstring.charCodeAt(i);
                }
                blob = new Blob([u8arr], { type: mime });
                console.log(blob);
            } else if (type === 'file') {
                blob = document.getElementById('file').files[0];
            }

            let response = await fetch('/api/posts', {
                method: 'POST',
                body: blob
            })

            if(!response.ok){
                alert('Post failed');
            }
        }
    </script>

</body>
</html>